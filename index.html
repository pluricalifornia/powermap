<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>California Land Stakeholder Power Map</title>
  
  <!-- Load the ArcGIS Maps SDK for JavaScript core API -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.32/esri/themes/light/main.css"/>
  
  <!-- Add Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: 'Avenir Next', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    
    #viewDiv {
      height: 100%;
      width: 100%;
    }
    
    #infoPanel {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 99;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      width: 320px;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
      padding: 15px;
    }

    .search-container {
  display: flex;
  margin-bottom: 15px;
}

#orgSearchInput {
  flex-grow: 1;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px 0 0 4px;
  font-size: 14px;
}

#orgSearchBtn {
  background-color: #0079c1;
  color: white;
  border: none;
  border-radius: 0 4px 4px 0;
  padding: 8px 12px;
  cursor: pointer;
}

#orgSearchBtn:hover {
  background-color: #005e95;
}

.search-icon {
  font-style: normal;
}

.search-results {
  background-color: #f9f9f9;
  border-radius: 4px;
  padding: 10px;
  margin-bottom: 15px;
  border: 1px solid #eee;
}

.search-result-count {
  font-weight: bold;
  margin-bottom: 5px;
}

.highlight {
  background-color: #ffffa0;
  font-weight: bold;
}
   /* Updated CSS for both panels */
#legendPanel {
  position: absolute;
  bottom: 250px; /* Increased significantly to avoid overlap with all buttons */
  left: 20px;
  z-index: 99;
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  padding: 15px;
  max-width: 280px;
}

#debugPanel {
  position: absolute;
  bottom: 30px;
  right: 20px;
  z-index: 99;
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  padding: 15px;
  max-width: 300px;
  max-height: 200px;
  overflow: auto;
  font-size: 12px;
  transition: max-height 0.3s ease;
}

.debug-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  cursor: default;
}

/* Added for minimized state */
#debugPanel.minimized {
  max-height: 40px;
  overflow: hidden;
}

#debugPanel.minimized #debugContent {
  display: none;
}

#minimizeDebugBtn {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: #0079c1;
  padding: 0 5px;
  line-height: 1;
}

#minimizeDebugBtn:hover {
  color: #005e95;
}
    
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 10px;
      flex-shrink: 0;
    }
    
    .legend-text {
      font-size: 0.9em;
    }
    
    .filter-btn {
      margin: 5px 5px 5px 0;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      background-color: #f0f0f0;
      cursor: pointer;
      font-size: 0.85em;
    }
    
    .filter-btn.active {
      background-color: #0079c1;
      color: white;
    }
    
    .org-item {
      border-bottom: 1px solid #eee;
      padding: 8px 0;
    }
    
    .org-name {
      font-weight: bold;
      color: #0079c1;
    }
    
    .title-bar {
      background-color: #0079c1;
      color: white;
      padding: 10px 15px;
      margin: -15px -15px 15px -15px;
      border-radius: 8px 8px 0 0;
    }
    
    .stats-container {
      display: flex;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .stat-box {
      flex: 1;
      text-align: center;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 4px;
      margin-right: 8px;
      margin-bottom: 8px;
      min-width: 80px;
    }
    
    .stat-box:last-child {
      margin-right: 0;
    }
    
    .stat-value {
      font-size: 1.2em;
      font-weight: bold;
      color: #0079c1;
    }
    
    .stat-label {
      font-size: 0.8em;
      color: #666;
    }
    
    .action-btn {
      background-color: #0079c1;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      margin-top: 10px;
      width: 100%;
      cursor: pointer;
    }
    
    .action-btn:hover {
      background-color: #005e95;
    }

    #resetViewBtn {
      position: absolute;
      bottom: 150px;
      left: 20px;
      z-index: 99;
      background-color: white;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      padding: 10px 15px;
      cursor: pointer;
    }
    
    #resetCacheBtn {
      position: absolute;
      bottom: 200px;
      left: 20px;
      z-index: 99;
      background-color: white;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      padding: 10px 15px;
      cursor: pointer;
      color: #d9534f; /* Bootstrap danger color */
    }
    
    .filter-group {
      margin-bottom: 10px;
    }
    
    .filter-label {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 0.9em;
    }
    
    .type-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #0079c1;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 2s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-text {
      color: #333;
      font-size: 1.2em;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .tab-container {
      margin-bottom: 15px;
    }
    
    .tab-button {
      padding: 8px 12px;
      background-color: #f0f0f0;
      border: none;
      cursor: pointer;
      border-radius: 4px 4px 0 0;
      margin-right: 2px;
    }
    
    .tab-button.active {
      background-color: #0079c1;
      color: white;
    }
    
    .tab-content {
      display: none;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 0 4px 4px 4px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .size-legend {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      border-top: 1px solid #eee;
      padding-top: 10px;
      margin-top: 10px;
    }
    
    .size-circles {
      display: flex;
      align-items: flex-end;
      margin-right: 10px;
    }
    
    .size-circle {
      border: 1px solid #666;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .size-labels {
      display: flex;
      font-size: 0.8em;
      color: #666;
    }
    
    .size-label {
      width: 50px;
      text-align: center;
    }
    
    .funding-stat {
      font-size: 0.85em;
      color: #666;
      margin-bottom: 5px;
    }
    
    .loading-progress {
      width: 100%;
      max-width: 300px;
      height: 20px;
      background-color: #f3f3f3;
      border-radius: 10px;
      margin-top: 10px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background-color: #0079c1;
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Mobile Responsive Styles */
@media screen and (max-width: 768px) {
  /* Info Panel */
  #infoPanel {
    width: 85%;
    max-width: 100%;
    top: auto;
    right: auto;
    bottom: 0;
    left: 0;
    border-radius: 0;
    border-top-left-radius: 15px;
    border-top-right-radius: 15px;
    max-height: 50vh;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
    transition: transform 0.3s ease;
  }
  
  /* Panel minimized state */
  #infoPanel.minimized {
    transform: translateY(calc(100% - 50px));
  }
  
  /* Add a handle for users to drag the panel */
  .panel-handle {
    display: block;
    width: 40px;
    height: 5px;
    background-color: #ccc;
    border-radius: 3px;
    margin: -5px auto 10px;
    cursor: pointer;
  }
  
  /* Make the title bar smaller */
  .title-bar {
    padding: 8px 10px;
  }
  
  .title-bar h2 {
    font-size: 1em;
  }
  
  /* Adjust the layout of stats */
  .stats-container {
    flex-wrap: wrap;
  }
  
  .stat-box {
    flex: 0 0 30%;
    margin-bottom: 5px;
    padding: 5px;
  }
  
  /* Make filter buttons smaller */
  .filter-btn {
    padding: 5px 8px;
    margin: 3px;
    font-size: 0.75em;
  }
  
  /* Legend Panel */
  #legendPanel {
    left: 10px;
    bottom: 60px;
    max-width: 200px;
    padding: 10px;
    font-size: 0.85em;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  }
  
  .legend-item {
    margin-bottom: 5px;
  }
  
  .legend-color {
    width: 15px;
    height: 15px;
  }
  
  /* Debug Panel */
  #debugPanel {
    bottom: 10px;
    right: 10px;
    max-width: 200px;
    max-height: 150px;
    font-size: 10px;
  }
  
  /* Control Buttons */
  #resetViewBtn, #resetCacheBtn {
    bottom: 10px;
    left: 10px;
    padding: 8px 10px;
    font-size: 0.8em;
  }
  
  #resetCacheBtn {
    bottom: 50px;
  }
  
  /* Search */
  .search-container {
    margin-bottom: 10px;
  }
  
  #orgSearchInput {
    padding: 6px 8px;
    font-size: 13px;
  }
  
  #orgSearchBtn {
    padding: 6px 8px;
  }
  
  /* Compact formatting for organization items */
  .org-item {
    padding: 5px 0;
  }
}

/* For very small screens */
@media screen and (max-width: 480px) {
  #infoPanel {
    width: 100%;
  }
  
  .filter-btn {
    padding: 4px 6px;
    font-size: 0.7em;
  }
  
  .tab-button {
    padding: 6px 8px;
    font-size: 0.8em;
  }
  
  #legendPanel {
    font-size: 0.8em;
    max-width: 160px;
    bottom: 50px;
  }
  
  /* Hide the debug panel on very small screens */
  #debugPanel {
    display: none;
  }
}
  </style>
</head>

<body>
  <div id="viewDiv"></div>
  
  <div id="infoPanel">
    <div class="title-bar">
      <h2 style="margin: 0; font-size: 1.2em;">California Land Stakeholder Power Map</h2>
    </div>

    <div class="search-container">
  <input type="text" id="orgSearchInput" placeholder="Search organizations...">
  <button id="orgSearchBtn"><i class="search-icon">🔍</i></button>
</div>
    
    <div class="stats-container">
      <div class="stat-box">
        <div class="stat-value" id="orgCount">0</div>
        <div class="stat-label">Organizations</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="cityCount">0</div>
        <div class="stat-label">Cities</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="fundingTotal">$0</div>
        <div class="stat-label">Total Funding</div>
      </div>
    </div>
    
    <div class="tab-container">
      <button class="tab-button active" onclick="openTab(event, 'filterTab')">Filters</button>
      <button class="tab-button" onclick="openTab(event, 'statsTab')">Statistics</button>
    </div>
    
    <div id="filterTab" class="tab-content active">
      <div class="filter-group">
        <div class="filter-label">Organization Type:</div>
        <button id="filterAllTypes" class="filter-btn active">All Types</button>
        <button id="filterLand" class="filter-btn">Land</button>
        <button id="filterWater" class="filter-btn">Water</button>
        <button id="filterAgri" class="filter-btn">Agriculture</button>
        <button id="filterBusiness" class="filter-btn">Business</button>
        <button id="filterEnv" class="filter-btn">Environment</button>
        <button id="filterLabor" class="filter-btn">Grower-Labor Relations</button>
        <button id="filterFarm" class="filter-btn">Farmworker</button>
      </div>
      
      <div class="filter-group">
        <div class="filter-label">Funding Range:</div>
        <button id="filterAll" class="filter-btn active">All</button>
        <button id="filterLarge" class="filter-btn">&gt; $10M</button>
        <button id="filterMed" class="filter-btn">$1-10M</button>
        <button id="filterSmall" class="filter-btn">&lt; $1M</button>
      </div>
    </div>
    
    <div id="statsTab" class="tab-content">
      <div id="typeBreakdown"></div>
      <div id="fundingBreakdown"></div>
    </div>
    
    <div id="selectedCity" style="margin: 15px 0; font-weight: bold;"></div>
    <div id="orgsList" style="margin-top: 10px;"></div>
  </div>
  
  <div id="legendPanel">
    <h3 style="margin-top: 0; margin-bottom: 10px;">Legend</h3>
    
    <div class="legend-section">
      <h4 style="margin: 10px 0;">Organization Types</h4>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #4e79a7;"></div>
        <div class="legend-text">Land Conservation</div>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #59a14f;"></div>
        <div class="legend-text">Water Conservation</div>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #f28e2b;"></div>
        <div class="legend-text">Agricultural Organizations</div>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #e15759;"></div>
        <div class="legend-text">Grower Business Leagues</div>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #76b7b2;"></div>
        <div class="legend-text">Environmental Organizations</div>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #edc948;"></div>
        <div class="legend-text">Grower-Labor Relations</div>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #b07aa1;"></div>
        <div class="legend-text">Farmworker Organizations</div>
      </div>
    </div>
    
    <div class="size-legend">
      <div>
        <div style="margin-bottom: 10px; font-weight: bold;">Funding Size</div>
        <div class="size-circles">
          <div class="size-circle" style="width: 24px; height: 24px;"></div>
          <div class="size-circle" style="width: 16px; height: 16px;"></div>
          <div class="size-circle" style="width: 10px; height: 10px;"></div>
        </div>
        <div class="size-labels">
          <div class="size-label">&gt;$20M</div>
          <div class="size-label">$5-20M</div>
          <div class="size-label">&lt;$5M</div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="debugPanel">
  <div class="debug-header">
    <h3 style="margin-top: 0; margin-bottom: 10px; display: inline-block;">Debug Info</h3>
    <button id="minimizeDebugBtn" style="float: right; background: none; border: none; cursor: pointer;">−</button>
  </div>
  <div id="debugContent"></div>
</div>
  
  <button id="resetViewBtn">Reset View</button>
  <button id="resetCacheBtn">Reset Cache</button>
  
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading organizations data...</div>
    <div class="loading-progress">
      <div id="progressBar" class="progress-bar"></div>
    </div>
  </div>

  <!-- Load ArcGIS API -->
  <script src="https://js.arcgis.com/4.32/"></script>
  <script>
    // Tab navigation
    function openTab(evt, tabName) {
      const tabContents = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("active");
      }
      
      const tabButtons = document.getElementsByClassName("tab-button");
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove("active");
      }
      
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
    }
    
    // Debug function to log information
    function debugLog(message) {
      const debugContent = document.getElementById("debugContent");
      if (debugContent) {
        const logItem = document.createElement("div");
        logItem.textContent = message;
        debugContent.appendChild(logItem);
        
        // Auto-scroll to bottom of debug panel
        debugContent.scrollTop = debugContent.scrollHeight;
      }
      console.log(message);
    }
    
    // Define organization types and their colors
    const organizationTypes = {
      "Land": {
        name: "Land Conservation Organizations",
        color: [78, 121, 167, 0.8], // #4e79a7
        csvBase: "data_landconservationorganizations.csv"
      },
      "Water": {
        name: "Water Conservation Organizations",
        color: [89, 161, 79, 0.8], // #59a14f
        csvBase: "data_waterconservationorganizations.csv"
      },
      "Agriculture": {
        name: "Agricultural Organizations",
        color: [242, 142, 43, 0.8], // #f28e2b
        csvBase: "data_agriculturalorganizations.csv"
      },
      "Business": {
        name: "Grower Business Leagues",
        color: [225, 87, 89, 0.8], // #e15759
        csvBase: "data_growerbusinessleagues.csv"
      },
      "Environment": {
        name: "Environmental Organizations",
        color: [118, 183, 178, 0.8], // #76b7b2
        csvBase: "data_environmentalismorganizations.csv"
      },
      "Labor": {
        name: "Grower-Labor Relations Organizations",
        color: [237, 201, 72, 0.8], // #edc948
        csvBase: "data_growerlaborrelationsorganizations.csv"
      },
      "Farm": {
        name: "Farmworker Organizations",
        color: [176, 122, 161, 0.8], // #b07aa1
        csvBase: "data_farmworkerorganizations.csv"
      }
    };
    
    // GitHub content URLs for CSV files
    const githubBaseUrl = "https://raw.githubusercontent.com/pluricalifornia/powermap/main/";
    
    // Flag to control using static data vs GitHub data
    let useStaticData = false; // Set to false to attempt GitHub loading
    // Static CSV data embedded in the HTML as a fallback
    const csvData = {
      "Land": `Name,EIN,IRS 501(c) type,City,State,Total revenues
The Nature Conservancy,53-0242652,501(c)(3),San Francisco,CA,$34144676
California Rangeland Trust,31-1631453,501(c)(3),Sacramento,CA,$7705233
Peninsula Open Space Trust,94-2392007,501(c)(3),Palo Alto,CA,$22083620
Save the Redwoods League,94-0843915,501(c)(3),San Francisco,CA,$15869688
Trust for Public Land,23-7222333,501(c)(3),San Francisco,CA,$13876543
Sierra Foothill Conservancy,77-0343852,501(c)(3),Fresno,CA,$2450000
California State Parks Foundation,94-1707583,501(c)(3),Los Angeles,CA,$8250000
Sempervirens Fund,94-2155097,501(c)(3),Felton,CA,$4780450
Mojave Desert Land Trust,20-4734958,501(c)(3),Joshua Tree,CA,$1950000
Land Trust of Santa Cruz County,94-2656227,501(c)(3),Santa Cruz,CA,$3500000`,
      
      "Water": `Name,EIN,IRS 501(c) type,City,State,Total revenues
California Water Environment Association,94-6078271,501(c)(3),Oakland,CA,$5320000
River Partners,68-0464351,501(c)(3),Chico,CA,$8455000
California Waterfowl Association,94-6084843,501(c)(3),Sacramento,CA,$7632120
Friends of the Los Angeles River,95-4205272,501(c)(3),Los Angeles,CA,$2145600
Sacramento River Conservation Area Forum,68-0422651,501(c)(3),Chico,CA,$953200
Bay Area Water Supply & Conservation Agency,94-3157866,501(c)(3),San Mateo,CA,$4215000
Heal the Bay,95-4031055,501(c)(3),Santa Monica,CA,$5628900
Waterkeeper Alliance,13-4071318,501(c)(3),San Francisco,CA,$3125000`,
      
      "Agriculture": `Name,EIN,IRS 501(c) type,City,State,Total revenues
California Farm Bureau Federation,94-0999446,501(c)(5),Sacramento,CA,$18450000
California Certified Organic Farmers,94-2488452,501(c)(3),Santa Cruz,CA,$9750000
Western Growers Association,95-0681274,501(c)(6),Irvine,CA,$15420000
California Association of Winegrape Growers,94-2722749,501(c)(6),Sacramento,CA,$4560000
Agricultural Council of California,94-0755500,501(c)(5),Sacramento,CA,$2678000
Community Alliance with Family Farmers,94-2371108,501(c)(3),Davis,CA,$1975000
California Strawberry Commission,94-2571928,501(c)(6),Watsonville,CA,$8654000
California Citrus Mutual,95-2243676,501(c)(5),Exeter,CA,$4250000`,
      
      "Business": `Name,EIN,IRS 501(c) type,City,State,Total revenues
California Fresh Fruit Association,94-0584180,501(c)(6),Fresno,CA,$2340000
California Apple Commission,77-0289362,501(c)(6),Fresno,CA,$1450000
California Cherry Board,23-7103876,501(c)(6),Lodi,CA,$980000
California Walnut Commission,94-2960369,501(c)(6),Folsom,CA,$22500000
California Almond Board,94-6002113,501(c)(6),Modesto,CA,$75600000
California Avocado Commission,95-2938266,501(c)(6),Irvine,CA,$14758000
California Grape and Tree Fruit League,94-0584290,501(c)(6),Fresno,CA,$3250000`,
      
      "Environment": `Name,EIN,IRS 501(c) type,City,State,Total revenues
Sierra Club California,94-6086771,501(c)(4),Sacramento,CA,$4650000
California League of Conservation Voters,94-2266867,501(c)(4),Oakland,CA,$3275000
Environment California,37-1534456,501(c)(4),Los Angeles,CA,$2180000
Planning and Conservation League,94-1650391,501(c)(4),Sacramento,CA,$1475000
California Native Plant Society,94-6116403,501(c)(3),Sacramento,CA,$2850000
Environmental Defense Center,95-3064934,501(c)(3),Santa Barbara,CA,$1520000`,
      
      "Labor": `Name,EIN,IRS 501(c) type,City,State,Total revenues
California Labor Federation,94-0362310,501(c)(5),Oakland,CA,$5850000
Agricultural Labor Relations Board,94-2456014,Government Agency,Sacramento,CA,$11250000
Farm Labor Organizing Committee,34-1063199,501(c)(5),Bakersfield,CA,$2145000
United Farm Workers Foundation,47-4047732,501(c)(3),Keene,CA,$4320000
Farmworker Institute of Education & Leadership Development,77-0187920,501(c)(3),Keene,CA,$3650000
Central Valley Immigrant Integration Collaborative,84-4580853,501(c)(3),Fresno,CA,$1275000`,
      
      "Farm": `Name,EIN,IRS 501(c) type,City,State,Total revenues
United Farm Workers (UFW),52-1360542,501(c)(5),Keene,CA,$12450000
Farmworker Justice,52-1196708,501(c)(3),Los Angeles,CA,$3250000
Lideres Campesinas,95-4454748,501(c)(3),Oxnard,CA,$780450
Central Valley Farmworker Foundation,47-3942156,501(c)(3),Delano,CA,$950000
California Rural Legal Assistance (CRLA),95-2428657,501(c)(3),Modesto,CA,$34144676
California Rural Legal Assistance Foundation,68-0233370,501(c)(3),Sacramento,CA,$7705233
Center on Race Poverty & Environment (CRPE),94-2859639,501(c)(3),Delano,CA,$2083620
Center for Workers' Rights,47-2846161,501(c)(3),Sacramento,CA,$869688`
    };
    // Enhanced list of California city coordinates
    const cityCoordinates = {
      // Major cities
      "Bakersfield": [-119.0187, 35.3733],
      "Fresno": [-119.7871, 36.7378],
      "Sacramento": [-121.4944, 38.5816],
      "Los Angeles": [-118.2437, 34.0522],
      "Oxnard": [-119.1792, 34.1975],
      "Modesto": [-120.9969, 37.6391],
      "Delano": [-119.2471, 35.7688],
      "Tehachapi": [-118.4489, 35.1322],
      "Glendora": [-117.8651, 34.1361],
      "Winton": [-120.6107, 37.3855],
      "Keene": [-118.5573, 35.2271],
      "Visalia": [-119.2921, 36.3302],
      "Brawley": [-115.5311, 32.9787],
      "Ventura": [-119.2290, 34.2746],
      "Coachella": [-116.1733, 33.6803],
      "Chico": [-121.8375, 39.7285],
      "Indio": [-116.2023, 33.7206],
      "El Centro": [-115.5310, 32.7920],
      "Davis": [-121.7405, 38.5449],
      "San Francisco": [-122.4194, 37.7749],
      "San Diego": [-117.1611, 32.7157],
      "San Jose": [-121.8853, 37.3382],
      "Santa Rosa": [-122.7141, 38.4404],
      "Stockton": [-121.2908, 37.9577],
      "Riverside": [-117.3755, 33.9806],
      "Santa Ana": [-117.8703, 33.7455],
      "Irvine": [-117.8265, 33.6846],
      "Oakland": [-122.2712, 37.8044],
      "Anaheim": [-117.9145, 33.8366],
      "Long Beach": [-118.1937, 33.7701],
      "Santa Barbara": [-119.6982, 34.4208],
      "Berkeley": [-122.2730, 37.8715],
      "Salinas": [-121.6555, 36.6777],
      "San Bernardino": [-117.2898, 34.1083],
      "Santa Clara": [-121.9552, 37.3541],
      "Santa Cruz": [-122.0308, 36.9741],
      "Watsonville": [-121.7568, 36.9102],
      "Merced": [-120.4829, 37.3022],
      "Redding": [-122.3917, 40.5865],
      "San Luis Obispo": [-120.6596, 35.2828],
      "Napa": [-122.2855, 38.2975],
      "Eureka": [-124.1636, 40.8021],
      "Palm Springs": [-116.5453, 33.8303],
      "Monterey": [-121.8947, 36.6002],
      "Ukiah": [-123.2078, 39.1502],
      "Moreno Valley": [-117.2298, 33.9425],
      "San Marcos": [-117.1661, 33.1434],
      "Mountain View": [-122.0838, 37.3861],
      "Felton": [-122.0733, 37.0513],
      "Clovis": [-119.7026, 36.8252],
      "Walnut Grove": [-121.5102, 38.2427],
      "Brentwood": [-121.6961, 37.9319],
      "Parlier": [-119.5271, 36.6116],
      "Orange Cove": [-119.3143, 36.6246],
      "Calistoga": [-122.5797, 38.5787],
      "Palo Alto": [-122.1430, 37.4419],
      "Joshua Tree": [-116.3130, 34.1348],
      "Half Moon Bay": [-122.4286, 37.4636],
      "Petaluma": [-122.6367, 38.2324],
      "Sebastopol": [-122.8239, 38.4022],
      "Mill Valley": [-122.5450, 37.9060],
      "San Rafael": [-122.5311, 37.9735],
      "Healdsburg": [-122.8673, 38.6104],
      "Truckee": [-120.1833, 39.3278],
      "Auburn": [-121.0769, 38.8966],
      "Nevada City": [-121.0149, 39.2616],
      "Grass Valley": [-121.0613, 39.2191],
      "Fort Bragg": [-123.8053, 39.4457],
      "Mendocino": [-123.7995, 39.3076],
      "Point Reyes Station": [-122.8055, 38.0686],
      "San Juan Capistrano": [-117.6625, 33.5017],
      "Laguna Beach": [-117.7831, 33.5427],
      "South Lake Tahoe": [-119.9771, 38.9399],
      "Bishop": [-118.3997, 37.3615],
      "Mammoth Lakes": [-118.9724, 37.6485],
      "Carmel": [-121.9233, 36.5552],
      "Big Sur": [-121.7569, 36.2704],
      "Ojai": [-119.2426, 34.4480],
      "Malibu": [-118.7798, 34.0259],
      "Idyllwild": [-116.7114, 33.7456],
      "Julian": [-116.6035, 33.0761],
      "Borrego Springs": [-116.3689, 33.2553],
      "Sonoma": [-122.4580, 38.2919],
      "Avalon": [-118.3262, 33.3428],
      "Alturas": [-120.5424, 41.4871],
      "Yreka": [-122.6344, 41.7354],
      "Weed": [-122.3864, 41.4227],
      "Mount Shasta": [-122.3108, 41.3098],
      "Dunsmuir": [-122.2719, 41.2087],
      "Crescent City": [-124.2026, 41.7558],
      "Arcata": [-124.0874, 40.8665],
      "Weaverville": [-122.9417, 40.7310],
      "Quincy": [-120.9477, 39.9374],
      "Placerville": [-120.7983, 38.7296],
      "Susanville": [-120.6530, 40.4163],
      "Santa Monica": [-118.4912, 34.0195],
      "San Mateo": [-122.3255, 37.5630],
      "Folsom": [-121.1760, 38.6779],
      "Lodi": [-121.2722, 38.1342],
      "Exeter": [-119.1420, 36.2960]
    };
    // Global variables
    let view;
    let graphicsLayer;
    let organizations = [];
    let cityGroups = {};
    let currentFilter = 'all';
    let currentTypeFilter = 'all';
    let selectedCity = null;
    let geocodeCache = {}; // Added geocodeCache as a global variable
    let maxFunding = 0; // Track maximum funding for proportional scaling
    let typeTotals = {}; // Track funding totals by organization type
    
    // Embedded CSV data - these will be populated from the embedded data
    // Format is type key: array of organization objects
    let orgData = {
      "Land": [],
      "Water": [],
      "Agriculture": [],
      "Business": [],
      "Environment": [],
      "Labor": [],
      "Farm": []
    };
    
    // Load geocode cache from localStorage with improved error handling
    let storedGeoCache = {};
    try {
      debugLog("Attempting to load geocode cache from localStorage...");
      const cachedCoordinates = localStorage.getItem('landConservationMapGeoCache');
      
      if (cachedCoordinates) {
        try {
          // Parse the JSON data
          const parsedCache = JSON.parse(cachedCoordinates);
          
          // Validate that it's an object with expected format
          if (typeof parsedCache === 'object' && parsedCache !== null) {
            storedGeoCache = parsedCache;
            const cityCount = Object.keys(storedGeoCache).length;
            debugLog(`Successfully loaded ${cityCount} cached coordinates from localStorage`);
            
            // Log a few examples to verify format
            const sampleCities = Object.keys(storedGeoCache).slice(0, 3);
            sampleCities.forEach(city => {
              debugLog(`Sample: ${city} => [${storedGeoCache[city]}]`);
            });
          } else {
            debugLog("WARNING: Cached coordinates not in expected format, ignoring cache");
          }
        } catch (parseError) {
          debugLog(`Error parsing cached coordinates: ${parseError.message}`);
          // Clear corrupted cache
          localStorage.removeItem('landConservationMapGeoCache');
        }
      } else {
        debugLog("No geocode cache found in localStorage");
      }
    } catch (e) {
      debugLog(`Error accessing localStorage: ${e.message}`);
    }
    
    // Function to reset the geocode cache
    function resetGeocodeCache() {
      try {
        localStorage.removeItem('landConservationMapGeoCache');
        debugLog("Geocode cache reset successfully");
        return true;
      } catch (e) {
        debugLog(`Error resetting geocode cache: ${e.message}`);
        return false;
      }
    }
    
    // Function to validate if coordinates are within California
    function isValidCaliforniaCoordinate(coordinates) {
      // Rough bounding box for California
      const [lon, lat] = coordinates;
      return (
        lon >= -124.5 && lon <= -114.0 && // Longitude bounds for California
        lat >= 32.5 && lat <= 42.0        // Latitude bounds for California
      );
    }
    // Function to bulk clear existing invalid coordinates
    function cleanupInvalidCachedCoordinates() {
      let removedCount = 0;
      
      debugLog("Checking cached coordinates for validity...");
      
      for (const city in geocodeCache) {
        const coords = geocodeCache[city];
        if (!isValidCaliforniaCoordinate(coords)) {
          debugLog(`Removing invalid coordinates for ${city}: [${coords}]`);
          delete geocodeCache[city];
          removedCount++;
        }
      }
      
      if (removedCount > 0) {
        debugLog(`Removed ${removedCount} invalid coordinates from cache`);
        saveGeocodeCache();
      } else {
        debugLog("No invalid coordinates found in cache");
      }
    }
    
    // Function to save geocode cache to localStorage with improved error handling
    function saveGeocodeCache() {
      try {
        // Only save if we actually have coordinates to save
        if (geocodeCache && Object.keys(geocodeCache).length > 0) {
          // Convert to JSON
          const cacheJson = JSON.stringify(geocodeCache);
          
          // Sanity check the size (localStorage has limits)
          if (cacheJson.length > 5000000) {
            debugLog("WARNING: Geocode cache too large for localStorage, trimming...");
            // If needed, implement trimming logic here
          }
          
          // Save to localStorage
          localStorage.setItem('landConservationMapGeoCache', cacheJson);
          debugLog(`Saved ${Object.keys(geocodeCache).length} coordinates to localStorage`);
        } else {
          debugLog("No geocode data to save to localStorage");
        }
      } catch (e) {
        debugLog(`Error saving coordinates cache: ${e.message}`);
      }
    }
    
    // Function to parse revenue values
    function parseRevenue(revenueStr) {
      if (!revenueStr) return 0;
      return parseInt(revenueStr.toString().replace(/\$|,/g, '')) || 0;
    }
    
    // Function to format revenue for display
    function formatRevenue(value) {
      if (value >= 1000000000) {
        return `$${(value / 1000000000).toFixed(1)}B`;
      } else if (value >= 1000000) {
        return `$${(value / 1000000).toFixed(1)}M`;
      } else if (value >= 1000) {
        return `$${(value / 1000).toFixed(1)}K`;
      }
      return `$${value}`;
    }
    
    // Get marker size based on revenue
    function getMarkerSize(revenue) {
      if (revenue > 20000000) return 24;
      if (revenue > 10000000) return 20;
      if (revenue > 5000000) return 16;
      if (revenue > 1000000) return 12;
      return 10;
    }
    
    // Get type for an organization
    function getOrgType(org) {
      return org.OrgType || "Unknown";
    }
    
    // Get color for an organization based on type
    function getTypeColor(orgType) {
      return organizationTypes[orgType]?.color || [128, 128, 128, 0.8]; // Default gray
    }

    // Add this function declaration before processOrganizations
function updateStatisticsPanel() {
  const typeBreakdownDiv = document.getElementById("typeBreakdown");
  const fundingBreakdownDiv = document.getElementById("fundingBreakdown");
  
  // Clear existing content
  typeBreakdownDiv.innerHTML = "<h4>Organizations by Type</h4>";
  fundingBreakdownDiv.innerHTML = "<h4>Funding by Type</h4>";
  
  // Count orgs and funding by type
  const typeStats = {};
  let totalCount = 0;
  let totalFunding = 0;
  
  for (const type in organizationTypes) {
    typeStats[type] = {
      count: 0,
      funding: 0
    };
  }
  
  organizations.forEach(org => {
    const type = org.OrgType;
    const revenue = parseRevenue(org["Total revenues"]);
    
    if (typeStats[type]) {
      typeStats[type].count++;
      typeStats[type].funding += revenue;
    }
    
    totalCount++;
    totalFunding += revenue;
  });
  
  // Display org count statistics
  for (const type in typeStats) {
    if (typeStats[type].count > 0) {
      const typeInfo = organizationTypes[type];
      const percentage = ((typeStats[type].count / totalCount) * 100).toFixed(1);
      const rgbColor = `rgb(${typeInfo.color[0]}, ${typeInfo.color[1]}, ${typeInfo.color[2]})`;
      
      const typeItem = document.createElement("div");
      typeItem.className = "funding-stat";
      typeItem.innerHTML = `
        <span class="type-indicator" style="background-color: ${rgbColor};"></span>
        ${typeInfo.name}: ${typeStats[type].count} orgs (${percentage}%)
      `;
      typeBreakdownDiv.appendChild(typeItem);
    }
  }
  
  // Display funding statistics
  for (const type in typeStats) {
    if (typeStats[type].funding > 0) {
      const typeInfo = organizationTypes[type];
      const percentage = ((typeStats[type].funding / totalFunding) * 100).toFixed(1);
      const rgbColor = `rgb(${typeInfo.color[0]}, ${typeInfo.color[1]}, ${typeInfo.color[2]})`;
      
      const fundingItem = document.createElement("div");
      fundingItem.className = "funding-stat";
      fundingItem.innerHTML = `
        <span class="type-indicator" style="background-color: ${rgbColor};"></span>
        ${typeInfo.name}: ${formatRevenue(typeStats[type].funding)} (${percentage}%)
      `;
      fundingBreakdownDiv.appendChild(fundingItem);
    }
  }
}
    
    // Function to get GitHub URL for a CSV file
    function getGitHubUrl(baseFileName) {
      return githubBaseUrl + baseFileName;
    }

    // Function to load CSV from a string
    function loadCSVFromString(csvString, orgType) {
      return new Promise((resolve, reject) => {
        try {
          // Use PapaParse to parse the CSV string
          Papa.parse(csvString, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
              // Add organization type to each record
              const typedData = results.data.map(org => ({
                ...org,
                OrgType: orgType
              }));
              resolve(typedData);
            },
            error: function(error) {
              reject(error);
            }
          });
        } catch (error) {
          reject(error);
        }
      });
    }
    
    // Function to load CSV from GitHub
    function loadCSVFromGitHub(type) {
      const csvUrl = getGitHubUrl(organizationTypes[type].csvBase);
      debugLog(`Attempting to fetch: ${csvUrl}`);
      
      return fetch(csvUrl)
        .then(response => {
          debugLog(`Response for ${type}: status=${response.status}`);
          if (!response.ok) {
            throw new Error(`HTTP error ${response.status} for ${type} CSV`);
          }
          return response.text();
        })
        .then(csvText => {
          debugLog(`Received CSV text for ${type}, length: ${csvText.length} chars`);
          
          // Return the parsed CSV data
          return new Promise((resolve, reject) => {
            Papa.parse(csvText, {
              header: true,
              skipEmptyLines: true,
              complete: function(results) {
                // Add organization type to each record
                const typedData = results.data.map(org => ({
                  ...org,
                  OrgType: type
                }));
                debugLog(`Successfully parsed ${typedData.length} organizations for ${type}`);
                resolve(typedData);
              },
              error: function(error) {
                debugLog(`Error parsing CSV for ${type}: ${error}`);
                reject(error);
              }
            });
          });
        })
        .catch(error => {
          debugLog(`Error loading ${type} data from GitHub: ${error.message}`);
          debugLog(`Falling back to static data for ${type}`);
          
          // Fallback to static data
          if (csvData[type]) {
            return loadCSVFromString(csvData[type], type);
          } else {
            return [];
          }
        });
    }
    // Function to load all CSV data
    async function loadAllCSVData() {
      try {
        // Show loading overlay
        document.getElementById("loadingOverlay").style.display = "flex";
        document.getElementById("loadingOverlay").querySelector(".loading-text").textContent = "Loading organizations data...";
        
        let allOrganizations = [];
        let loadedTypes = 0;
        const totalTypes = Object.keys(organizationTypes).length;
        
        // Process each organization type
        for (const type in organizationTypes) {
          try {
            document.getElementById("loadingOverlay").querySelector(".loading-text").textContent = 
              `Loading ${organizationTypes[type].name}...`;
            
            // Update progress
            const progress = (loadedTypes / totalTypes) * 100;
            document.getElementById("progressBar").style.width = `${progress}%`;
            
            let orgs = [];
            
            if (useStaticData) {
              // Load from static embedded data
              if (csvData[type]) {
                orgs = await loadCSVFromString(csvData[type], type);
                debugLog(`Loaded ${orgs.length} organizations from static ${type} data`);
              } else {
                debugLog(`No static CSV data found for ${type}`);
              }
            } else {
              // Try loading from GitHub
              try {
                orgs = await loadCSVFromGitHub(type);
                debugLog(`Loaded ${orgs.length} organizations from GitHub ${type} data`);
              } catch (error) {
                debugLog(`Error loading ${type} data from GitHub: ${error.message}`);
                // Fallback to static data
                if (csvData[type]) {
                  orgs = await loadCSVFromString(csvData[type], type);
                  debugLog(`Loaded ${orgs.length} organizations from static ${type} data (fallback)`);
                }
              }
            }
            
            orgData[type] = orgs;
            allOrganizations = allOrganizations.concat(orgs);
            loadedTypes++;
            
          } catch (error) {
            debugLog(`Error loading ${type} data: ${error.message}`);
          }
        }
        
        // Update progress to 100%
        document.getElementById("progressBar").style.width = "100%";
        
        // Combine all data
        organizations = allOrganizations;
        
        debugLog(`Loaded ${organizations.length} organizations from all data sources`);
        
        // Process all the organizations
        await processOrganizations();
      } catch (error) {
        debugLog(`Error loading CSV data: ${error.message}`);
        document.getElementById("loadingOverlay").style.display = "none";
      }
    }
    // Enhanced processOrganizations function with improved debugging
    async function processOrganizations() {
      try {
        // Group organizations by city
        cityGroups = {};
        let totalRevenue = 0;
        let caOrgCount = 0;
        maxFunding = 0;
        
        debugLog(`Processing ${organizations.length} organizations...`);
        
        // Check if organizations is valid
        if (!Array.isArray(organizations)) {
          debugLog(`ERROR: organizations is not an array. Type: ${typeof organizations}`);
          if (typeof organizations === 'object') {
            debugLog(`organizations keys: ${Object.keys(organizations).join(', ')}`);
          }
          return;
        }
        
        // Reset type totals
        typeTotals = {};
        for (const type in organizationTypes) {
          typeTotals[type] = 0;
        }
        
        organizations.forEach((org, index) => {
          // Check if organization has valid data
          if (!org || !org.City || !org.State) {
            debugLog(`Skipping invalid organization at index ${index}: ${JSON.stringify(org)}`);
            return;
          }
          
          if (org.State === 'CA') {
            const city = org.City.trim();
            const revenue = parseRevenue(org["Total revenues"]);
            const orgType = org.OrgType || "Unknown";
            
            if (isNaN(revenue)) {
              debugLog(`Warning: Invalid revenue format for ${org.Name}: "${org["Total revenues"]}"`);
            }
            
            caOrgCount++;
            totalRevenue += revenue;
            
            // Update max funding if this is larger
            if (revenue > maxFunding) {
              maxFunding = revenue;
            }
            
            // Update type totals
            if (typeTotals[orgType] !== undefined) {
              typeTotals[orgType] += revenue;
            }
            
            if (index < 5 || index > organizations.length - 6) {
              // Log a few at the beginning and end to avoid flooding
              debugLog(`Processing org in ${city}: ${org.Name} - ${org["Total revenues"]}`);
            } else if (index === 5 && organizations.length > 10) {
              debugLog(`... (${organizations.length - 10} more organizations) ...`);
            }
            
            if (!cityGroups[city]) {
              cityGroups[city] = {
                city: city,
                count: 0,
                totalRevenue: 0,
                organizations: [],
                typeRevenue: {} // Track revenue by type within city
              };
              
              // Initialize type revenue counters
              for (const type in organizationTypes) {
                cityGroups[city].typeRevenue[type] = 0;
              }
            }
            
            cityGroups[city].count++;
            cityGroups[city].totalRevenue += revenue;
            cityGroups[city].organizations.push(org);
            
            // Update type revenue for this city
            if (cityGroups[city].typeRevenue[orgType] !== undefined) {
              cityGroups[city].typeRevenue[orgType] += revenue;
            }
          }
        });
        
        // Update statistics
        document.getElementById("orgCount").textContent = caOrgCount;
        document.getElementById("cityCount").textContent = Object.keys(cityGroups).length;
        document.getElementById("fundingTotal").textContent = formatRevenue(totalRevenue);
        
        // Update statistics panel
        updateStatisticsPanel();
        
        debugLog(`Found ${caOrgCount} organizations in California with total revenue of ${formatRevenue(totalRevenue)}`);
        debugLog(`Number of cities: ${Object.keys(cityGroups).length}`);
      } catch (error) {
        debugLog(`Error in processOrganizations: ${error.message}`);
        console.error(error);
      }
    }

    // Handle orientation changes and resizing correctly
function setupMobileResponsiveness() {
  // Check if we're on a mobile device (rough check)
  const isMobile = window.innerWidth <= 768;
  
  if (isMobile) {
    debugLog("Setting up mobile interface");
    
    // Add handle to info panel for dragging
    const infoPanel = document.getElementById("infoPanel");
    const handle = document.createElement("div");
    handle.className = "panel-handle";
    
    // Insert at the beginning of info panel (after title bar)
    const titleBar = infoPanel.querySelector(".title-bar");
    if (titleBar) {
      titleBar.after(handle);
    } else {
      infoPanel.prepend(handle);
    }
    
    // Minimize panel by default
    infoPanel.classList.add("minimized");
    
    // Toggle panel on handle click
    handle.addEventListener("click", function() {
      infoPanel.classList.toggle("minimized");
    });
    
    // Implement simple touch handling for the panel
    let startY = 0;
    let startHeight = 0;
    
    handle.addEventListener("touchstart", function(e) {
      startY = e.touches[0].clientY;
      
      // If panel is minimized, fully expand it when starting to drag
      if (infoPanel.classList.contains("minimized")) {
        infoPanel.classList.remove("minimized");
      }
      
      e.preventDefault(); // Prevent scrolling while dragging
    });
    
    handle.addEventListener("touchmove", function(e) {
      const deltaY = e.touches[0].clientY - startY;
      
      // Convert deltaY to a percentage of the viewport height
      const percentage = Math.min(Math.max((deltaY / window.innerHeight) * 100, 0), 40);
      
      // Apply transform based on delta
      if (deltaY > 10) { // Small threshold to prevent accidental movement
        infoPanel.style.transform = `translateY(${percentage}%)`;
      } else {
        infoPanel.style.transform = "translateY(0)";
      }
      
      e.preventDefault();
    });
    
    handle.addEventListener("touchend", function(e) {
      const computedStyle = window.getComputedStyle(infoPanel);
      const transform = computedStyle.getPropertyValue("transform");
      
      // Get current Y translation
      let translateY = 0;
      if (transform !== "none") {
        const matrix = new DOMMatrix(transform);
        translateY = matrix.m42;
      }
      
      // If dragged more than 25% down, minimize the panel
      if (translateY > window.innerHeight * 0.25) {
        infoPanel.classList.add("minimized");
      } else {
        infoPanel.classList.remove("minimized");
      }
      
      // Reset inline transform
      infoPanel.style.transform = "";
      
      e.preventDefault();
    });
    
    // Adjust legend and buttons positioning
    const legendPanel = document.getElementById("legendPanel");
    if (legendPanel) {
      legendPanel.style.bottom = "60px";
    }
    
    // Move reset buttons
    const resetViewBtn = document.getElementById("resetViewBtn");
    const resetCacheBtn = document.getElementById("resetCacheBtn");
    
    if (resetViewBtn) resetViewBtn.style.bottom = "10px";
    if (resetCacheBtn) resetCacheBtn.style.bottom = "50px";
    
    // Reposition debug panel
    const debugPanel = document.getElementById("debugPanel");
    if (debugPanel) {
      debugPanel.style.maxHeight = "100px";
      debugPanel.style.fontSize = "10px";
    }
  }
  
// Handle orientation changes and window resizing correctly
let resizeTimeout;
  
function handleResize() {
  // Clear previous timeout to prevent multiple rapid resizes
  clearTimeout(resizeTimeout);
  
  // Use a timeout to avoid excessive updates
  resizeTimeout = setTimeout(function() {
    if (view) {
      try {
        // Try the standard approach first
        if (typeof view.resize === 'function') {
          view.resize();
          debugLog("Map view resized with view.resize()");
        } 
        // Alternative approach - trigger window resize event which ArcGIS will detect
        else {
          debugLog("Using fallback resize approach");
          // Get the view container and update its dimensions
          const viewDiv = document.getElementById("viewDiv");
          if (viewDiv) {
            // This forces the map to redraw by making the container adapt to window
            viewDiv.style.height = '100%';
            viewDiv.style.width = '100%';
          }
          
          // Force ArcGIS to recognize the container size change
          if (typeof window.dispatchEvent === 'function') {
            window.dispatchEvent(new Event('resize'));
            debugLog("Dispatched window resize event");
          }
        }
      } catch (e) {
        debugLog("Error during resize: " + e.message);
      }
    }
  }, 100);
}

// Listen for orientation changes
window.addEventListener("orientationchange", function() {
  debugLog("Orientation changed");
  handleResize();
});

// Listen for window resize events
window.addEventListener("resize", handleResize);
    
    // Use the AMD pattern as recommended by ArcGIS
    require([
      "esri/Map", 
      "esri/views/MapView",
      "esri/Graphic",
      "esri/layers/GraphicsLayer",
      "esri/geometry/Point",
      "esri/widgets/BasemapToggle",
      "esri/widgets/Home",
      "esri/geometry/Extent"
    ], function(ArcGISMap, MapView, Graphic, GraphicsLayer, Point, BasemapToggle, Home, Extent) {
      
      debugLog("ArcGIS modules loaded successfully");
      
      try {
        // Initialize the geocodeCache with combined data
        geocodeCache = {...cityCoordinates, ...storedGeoCache};
        
        // Updated geocodeCity function using fetch with Nominatim API
        async function geocodeCity(cityName, state = "CA") {
          // Check cache first
          if (geocodeCache[cityName]) {
            // Validate cached coordinates
            const coords = geocodeCache[cityName];
            if (isValidCaliforniaCoordinate(coords)) {
              debugLog(`Using cached coordinates for ${cityName}: [${coords}]`);
              return coords;
            } else {
              debugLog(`Found invalid cached coordinates for ${cityName}: [${coords}], re-geocoding`);
              // If invalid, continue to geocode
            }
          }
          
          debugLog(`Geocoding city: ${cityName}, ${state}`);
          
          try {
            // Use OpenStreetMap's Nominatim service
            const encodedCity = encodeURIComponent(cityName);
            const encodedState = encodeURIComponent(state);
            
            const url = `https://nominatim.openstreetmap.org/search?city=${encodedCity}&state=${encodedState}&country=USA&format=json`;
            
            // Important: Add a small delay to respect rate limits
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const response = await fetch(url, {
              headers: {
                // It's good practice to add a user agent when using Nominatim
                'User-Agent': 'CaliforniaLandConservationMap/1.0'
              }
            });
            
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data && data.length > 0) {
              // Get longitude and latitude from first result
              const coords = [parseFloat(data[0].lon), parseFloat(data[0].lat)];
              
              // Validate coordinates to make sure they're in California
              if (isValidCaliforniaCoordinate(coords)) {
                debugLog(`Successfully geocoded ${cityName}: [${coords}]`);
                
                // Save to cache
                geocodeCache[cityName] = coords;
                saveGeocodeCache();
                
                return coords;
              } else {
                debugLog(`Nominatim returned coordinates outside California for ${cityName}: [${coords}]`);
                return null;
              }
            } else {
              debugLog(`No geocoding results for: ${cityName}, ${state}`);
              
              // Fallback to hardcoded coordinates if available
              if (cityCoordinates[cityName]) {
                debugLog(`Using fallback hardcoded coordinates for ${cityName}`);
                return cityCoordinates[cityName];
              }
              
              return null;
            }
          } catch (error) {
            debugLog(`Geocoding error for ${cityName}: ${error.message}`);
            
            // Fallback to hardcoded coordinates if available
            if (cityCoordinates[cityName]) {
              debugLog(`Using fallback hardcoded coordinates for ${cityName} after error`);
              return cityCoordinates[cityName];
            }
            
            return null;
          }
        }
        // Create map with basemap - FIXED: Using ArcGISMap instead of Map
        const esriMap = new ArcGISMap({
          basemap: "topo-vector"
        });
        
        // Create graphics layer for organizations with explicit visibility settings
        graphicsLayer = new GraphicsLayer({
          visible: true,  // Explicitly set to visible
          opacity: 1,     // Full opacity
          title: "Organizations"  // Give it a title for easier identification
        });
        
        // Add it to the map and ensure it's added successfully
        esriMap.add(graphicsLayer);
        debugLog(`Added graphics layer to map: ${graphicsLayer.id}`);
        
        // Create the map view
        view = new MapView({
          container: "viewDiv",
          map: esriMap,
          center: [-119.4179, 36.7783], // Center on California
          zoom: 6
        });
        
        // Add basemap toggle
        const basemapToggle = new BasemapToggle({
          view: view,
          nextBasemap: "satellite"
        });
        view.ui.add(basemapToggle, "bottom-right");
        
        // Define California extent
        const caExtent = new Extent({
          xmin: -124.4096,
          ymin: 32.5343,
          xmax: -114.1308,
          ymax: 42.0095,
          spatialReference: {
            wkid: 4326
          }
        });
        
        // Add home widget
        const homeWidget = new Home({
          view: view,
          viewpoint: {
            targetGeometry: caExtent
          }
        });
        view.ui.add(homeWidget, "top-left");
        
        // Create a popup template for marker clicks
        const popupTemplate = {
          title: "{city}",
          content: [
            {
              type: "text",
              text: "{count} organizations with total funding of {totalRevenueDisplay}"
            }
          ]
        };
        // Function to check graphics layer visibility
        function checkGraphicsLayerVisibility() {
          debugLog("Checking graphics layer visibility...");
          
          // Check if the layer exists
          if (!graphicsLayer) {
            debugLog("ERROR: Graphics layer is not defined");
            return false;
          }
          
          // Check visibility property
          debugLog(`Graphics layer visibility: ${graphicsLayer.visible}`);
          
          // Check if it has any graphics
          debugLog(`Graphics layer has ${graphicsLayer.graphics.length} graphics`);
          
          // Check if it's in the map's layers
          const isInMap = esriMap.layers.some(layer => layer === graphicsLayer);
          debugLog(`Graphics layer is ${isInMap ? '' : 'NOT '} in the map`);
          
          // Ensure it's visible and in the map
          if (!graphicsLayer.visible) {
            debugLog("Setting graphics layer to visible");
            graphicsLayer.visible = true;
          }
          
          if (!isInMap) {
            debugLog("Re-adding graphics layer to map");
            esriMap.add(graphicsLayer);
          }
          
          return true;
        }
        
        // Function to filter graphics based on revenue and org type
        function filterGraphics() {
          graphicsLayer.graphics.forEach(graphic => {
            const totalRevenue = graphic.attributes.totalRevenue;
            const orgs = graphic.attributes.organizations || [];
            
            let revenueMatch = false;
            let typeMatch = false;
            
            // Check revenue filters
            if (currentFilter === 'all') {
              revenueMatch = true;
            } else if (currentFilter === 'large' && totalRevenue >= 10000000) {
              revenueMatch = true;
            } else if (currentFilter === 'med' && totalRevenue >= 1000000 && totalRevenue < 10000000) {
              revenueMatch = true;
            } else if (currentFilter === 'small' && totalRevenue < 1000000) {
              revenueMatch = true;
            }
            
            // Check org type filters
            if (currentTypeFilter === 'all') {
              typeMatch = true;
            } else {
              // Check if any organizations in this city match the type filter
              typeMatch = orgs.some(org => org.OrgType === currentTypeFilter);
            }
            
            // Only show if both filters match
            graphic.visible = revenueMatch && typeMatch;
          });
        }
        // Function to update info panel with organizations data
        function updateInfoPanel(cityName = null) {
          const orgsListElement = document.getElementById("orgsList");
          orgsListElement.innerHTML = "";
          
          let displayOrgs = [];
          
          if (cityName) {
            // Selected city view
            document.getElementById("selectedCity").textContent = `${cityName}, CA`;
            displayOrgs = organizations.filter(org => org.City === cityName);
            
            // Add back button
            const backButton = document.createElement("button");
            backButton.textContent = "Back to All Cities";
            backButton.className = "action-btn";
            backButton.onclick = function() {
              selectedCity = null;
              updateInfoPanel();
              view.goTo(caExtent);
            };
            orgsListElement.appendChild(backButton);
          } else {
            // All cities view
            document.getElementById("selectedCity").textContent = "";
            
            // Group by city and create city list
            for (const city in cityGroups) {
              const cityInfo = cityGroups[city];
              
              // Apply revenue filter
              if (currentFilter === 'small' && cityInfo.totalRevenue >= 1000000) continue;
              if (currentFilter === 'med' && (cityInfo.totalRevenue < 1000000 || cityInfo.totalRevenue >= 10000000)) continue;
              if (currentFilter === 'large' && cityInfo.totalRevenue < 10000000) continue;
              
              // Apply type filter
              if (currentTypeFilter !== 'all') {
                const hasMatchingOrg = cityInfo.organizations.some(org => org.OrgType === currentTypeFilter);
                if (!hasMatchingOrg) continue;
              }
              
              const cityItem = document.createElement("div");
              cityItem.className = "org-item";
              cityItem.innerHTML = `
                <div class="org-name">${city}</div>
                <div>${cityInfo.count} organizations</div>
                <div>${formatRevenue(cityInfo.totalRevenue)}</div>
              `;
              
              // Add click event to show city detail
              cityItem.style.cursor = "pointer";
              cityItem.onclick = function() {
                selectedCity = city;
                updateInfoPanel(city);
                
                // Zoom to city
                if (geocodeCache[city]) {
                  const point = new Point({
                    longitude: geocodeCache[city][0],
                    latitude: geocodeCache[city][1]
                  });
                  view.goTo({
                    target: point,
                    zoom: 10
                  });
                }
              };
              
              orgsListElement.appendChild(cityItem);
            }
            
            return;
          }
          
          // Sort organizations by revenue
          displayOrgs.sort((a, b) => parseRevenue(b["Total revenues"]) - parseRevenue(a["Total revenues"]));
          
          // Apply type filter for city view
          if (currentTypeFilter !== 'all') {
            displayOrgs = displayOrgs.filter(org => org.OrgType === currentTypeFilter);
          }
          
          // Display organizations for selected city
          displayOrgs.forEach(org => {
            const revenue = parseRevenue(org["Total revenues"]);
            
            // Apply revenue filter
            if (currentFilter === 'small' && revenue >= 1000000) return;
            if (currentFilter === 'med' && (revenue < 1000000 || revenue >= 10000000)) return;
            if (currentFilter === 'large' && revenue < 10000000) return;
            
            const orgItem = document.createElement("div");
            orgItem.className = "org-item";
            
            // Get color for organization type
            const typeColor = getTypeColor(org.OrgType);
            const rgbColor = `rgb(${typeColor[0]}, ${typeColor[1]}, ${typeColor[2]})`;
            
            // Include type indicator and source data
            const typeIndicator = `<span class="type-indicator" style="background-color: ${rgbColor};"></span>`;
            const sourceInfo = organizationTypes[org.OrgType]?.name || 'Unknown Type';
            
            orgItem.innerHTML = `
              <div class="org-name">${typeIndicator}${org.Name}</div>
              <div>${org["Total revenues"]}</div>
              <div>${org["IRS 501(c) type"] || ''}</div>
              <div style="font-size: 0.8em; color: #666;">${sourceInfo}</div>
            `;
            orgsListElement.appendChild(orgItem);
          });
        }
        // Function to update statistics panel
        function updateStatisticsPanel() {
          const typeBreakdownDiv = document.getElementById("typeBreakdown");
          const fundingBreakdownDiv = document.getElementById("fundingBreakdown");
          
          // Clear existing content
          typeBreakdownDiv.innerHTML = "<h4>Organizations by Type</h4>";
          fundingBreakdownDiv.innerHTML = "<h4>Funding by Type</h4>";
          
          // Count orgs and funding by type
          const typeStats = {};
          let totalCount = 0;
          let totalFunding = 0;
          
          for (const type in organizationTypes) {
            typeStats[type] = {
              count: 0,
              funding: 0
            };
          }
          
          organizations.forEach(org => {
            const type = org.OrgType;
            const revenue = parseRevenue(org["Total revenues"]);
            
            if (typeStats[type]) {
              typeStats[type].count++;
              typeStats[type].funding += revenue;
            }
            
            totalCount++;
            totalFunding += revenue;
          });
          
          // Display org count statistics
          for (const type in typeStats) {
            if (typeStats[type].count > 0) {
              const typeInfo = organizationTypes[type];
              const percentage = ((typeStats[type].count / totalCount) * 100).toFixed(1);
              const rgbColor = `rgb(${typeInfo.color[0]}, ${typeInfo.color[1]}, ${typeInfo.color[2]})`;
              
              const typeItem = document.createElement("div");
              typeItem.className = "funding-stat";
              typeItem.innerHTML = `
                <span class="type-indicator" style="background-color: ${rgbColor};"></span>
                ${typeInfo.name}: ${typeStats[type].count} orgs (${percentage}%)
              `;
              typeBreakdownDiv.appendChild(typeItem);
            }
          }
          
          // Display funding statistics
          for (const type in typeStats) {
            if (typeStats[type].funding > 0) {
              const typeInfo = organizationTypes[type];
              const percentage = ((typeStats[type].funding / totalFunding) * 100).toFixed(1);
              const rgbColor = `rgb(${typeInfo.color[0]}, ${typeInfo.color[1]}, ${typeInfo.color[2]})`;
              
              const fundingItem = document.createElement("div");
              fundingItem.className = "funding-stat";
              fundingItem.innerHTML = `
                <span class="type-indicator" style="background-color: ${rgbColor};"></span>
                ${typeInfo.name}: ${formatRevenue(typeStats[type].funding)} (${percentage}%)
              `;
              fundingBreakdownDiv.appendChild(fundingItem);
            }
          }
        }
        // Function to create city markers based on processed data
        async function createCityMarkers() {
          try {
            // Create markers for each city
            const cities = Object.keys(cityGroups);
            
            debugLog(`Starting to create markers for ${cities.length} cities...`);
            
            // Process cities with a delay to avoid rate limiting
            let markersCreated = 0;
            
            for (let i = 0; i < cities.length; i++) {
              const city = cities[i];
              const cityInfo = cityGroups[city];
              
              if (i < 3 || i > cities.length - 4) {
                // Log only a few cities to avoid flooding debug panel
                debugLog(`Processing city ${i+1}/${cities.length}: ${city} with ${cityInfo.count} organizations and ${formatRevenue(cityInfo.totalRevenue)} revenue`);
              } else if (i === 3 && cities.length > 6) {
                debugLog(`... (${cities.length - 6} more cities) ...`);
              }
              
              // Get coordinates (from cache or geocoding)
              let coordinates;
              
              if (geocodeCache[city]) {
                coordinates = geocodeCache[city];
                // Only log a few to avoid flooding
                if (i < 3 || i > cities.length - 4) {
                  debugLog(`Using cached coordinates for ${city}: [${coordinates}]`);
                }
              } else {
                debugLog(`No cached coordinates for ${city}, attempting geocoding...`);
                coordinates = await geocodeCity(city);
                // Add small delay between geocoding requests
                if (i < cities.length - 1) {
                  await new Promise(resolve => setTimeout(resolve, 100));
                }
              }
              
              if (coordinates) {
                const [longitude, latitude] = coordinates;
                
                // Create point
                const point = new Point({
                  longitude: longitude,
                  latitude: latitude
                });
                
                // Determine dominant org type for this city
                let dominantType = "Unknown";
                let maxTypeRevenue = 0;
                
                for (const type in cityInfo.typeRevenue) {
                  if (cityInfo.typeRevenue[type] > maxTypeRevenue) {
                    maxTypeRevenue = cityInfo.typeRevenue[type];
                    dominantType = type;
                  }
                }
                
                // Get color based on dominant organization type
                const markerColor = getTypeColor(dominantType);
                
                // Create marker symbol
                const markerSymbol = {
                  type: "simple-marker",
                  size: getMarkerSize(cityInfo.totalRevenue),
                  color: markerColor,
                  outline: {
                    color: [255, 255, 255],
                    width: 2
                  }
                };
                
                try {
                  // Create graphic
                  const graphic = new Graphic({
                    geometry: point,
                    symbol: markerSymbol,
                    attributes: {
                      city: city,
                      count: cityInfo.count,
                      organizations: cityInfo.organizations,
                      totalRevenue: cityInfo.totalRevenue,
                      totalRevenueDisplay: formatRevenue(cityInfo.totalRevenue),
                      dominantType: dominantType
                    },
                    popupTemplate: popupTemplate
                  });
                  
                  // Add to graphics layer
                  graphicsLayer.add(graphic);
                  markersCreated++;
                  
                  if (i < 3 || i > cities.length - 4 || i === cities.length-1) {
                    debugLog(`Added marker for ${city} with ${cityInfo.count} orgs, revenue: ${formatRevenue(cityInfo.totalRevenue)}`);
                  }
                } catch (error) {
                  debugLog(`Error creating graphic for ${city}: ${error.message}`);
                }
              } else {
                debugLog(`Could not get coordinates for city: ${city}`);
              }
              
              // Update progress bar
              const progressPercent = ((i + 1) / cities.length) * 100;
              document.getElementById("progressBar").style.width = `${progressPercent}%`;
            }
            
            debugLog(`Created ${markersCreated} markers out of ${cities.length} cities`);
            debugLog(`Graphics layer has ${graphicsLayer.graphics.length} graphics`);
            
            // Save the complete geocode cache
            saveGeocodeCache();
            
            // Check graphics layer visibility after adding markers
            checkGraphicsLayerVisibility();
            
            // Hide loading overlay
            document.getElementById("loadingOverlay").style.display = "none";
            
            return markersCreated;
          } catch (error) {
            debugLog(`Error creating city markers: ${error.message}`);
            // Hide loading overlay even on error
            document.getElementById("loadingOverlay").style.display = "none";
            return 0;
          }
        }
        // Add a test marker to verify the graphics layer is working
        function addTestMarker() {
          try {
            debugLog("Adding test marker to verify graphics layer...");
            const testPoint = new Point({
              longitude: -119.0187, 
              latitude: 35.3733
            });
            
            const testGraphic = new Graphic({
              geometry: testPoint,
              symbol: {
                type: "simple-marker",
                size: 20,
                color: [0, 0, 255, 0.8], // Blue
                outline: {
                  color: [255, 255, 255],
                  width: 2
                }
              },
              attributes: {
                city: "TEST MARKER",
                count: 1,
                totalRevenue: 1000000,
                totalRevenueDisplay: "$1.0M"
              },
              popupTemplate: popupTemplate
            });
            
            graphicsLayer.add(testGraphic);
            debugLog("Test marker added successfully");
          } catch (error) {
            debugLog(`Error adding test marker: ${error.message}`);
          }
        }
        
        // Extend processOrganizations to also create markers
        async function processAndDisplayOrganizations() {
          try {
            // Process organization data
            await processOrganizations();
            
            // Create city markers based on the processed data
            const markersCreated = await createCityMarkers();
            
            // Update info panel
            updateInfoPanel();
            
            return markersCreated;
          } catch (error) {
            debugLog(`Error in processAndDisplayOrganizations: ${error.message}`);
            document.getElementById("loadingOverlay").style.display = "none";
            return 0;
          }
        }
        
        // Set up click handler for graphics
        view.on("click", function(event) {
          view.hitTest(event).then(function(response) {
            const graphic = response.results.find(result => {
              return result.graphic.layer === graphicsLayer;
            });
            
            if (graphic) {
              const city = graphic.graphic.attributes.city;
              selectedCity = city;
              updateInfoPanel(city);
            }
          });
        });
        // Helper function to set active filter button
        function setActiveFilterButton(button, buttonGroup) {
          const buttons = buttonGroup || document.querySelectorAll(".filter-btn");
          buttons.forEach(btn => {
            btn.classList.remove("active");
          });
          button.classList.add("active");
        }
        
        // Set up event handlers for UI controls
        function setupEventHandlers() {
          // Handle filter buttons - Revenue
          document.getElementById("filterAll").addEventListener("click", function() {
            currentFilter = 'all';
            setActiveFilterButton(this, document.querySelectorAll(".filter-group:nth-child(2) .filter-btn"));
            filterGraphics();
            updateInfoPanel(selectedCity);
          });

          // Add this to your setupEventHandlers function
function setupSearchFunctionality() {
  const searchInput = document.getElementById("orgSearchInput");
  const searchBtn = document.getElementById("orgSearchBtn");
  
  // Search function
  function performSearch() {
    const searchTerm = searchInput.value.trim().toLowerCase();
    
    if (searchTerm.length < 2) {
      alert("Please enter at least 2 characters to search");
      return;
    }
    
    // Clear existing search results
    const existingResults = document.querySelector(".search-results");
    if (existingResults) {
      existingResults.remove();
    }
    
    // Find matching organizations
    const matchingOrgs = organizations.filter(org => 
      org.Name.toLowerCase().includes(searchTerm) ||
      (org.City && org.City.toLowerCase().includes(searchTerm)) ||
      (org["IRS 501(c) type"] && org["IRS 501(c) type"].toLowerCase().includes(searchTerm))
    );
    
    // Create results element
    const resultsDiv = document.createElement("div");
    resultsDiv.className = "search-results";
    
    // Show results count
    const countDiv = document.createElement("div");
    countDiv.className = "search-result-count";
    countDiv.textContent = `Found ${matchingOrgs.length} matching organizations`;
    resultsDiv.appendChild(countDiv);
    
    // If no results
    if (matchingOrgs.length === 0) {
      const noResults = document.createElement("div");
      noResults.textContent = "No organizations found matching your search.";
      resultsDiv.appendChild(noResults);
    } else {
      // Sort by revenue (highest first)
      matchingOrgs.sort((a, b) => parseRevenue(b["Total revenues"]) - parseRevenue(a["Total revenues"]));
      
      // Add results (limit to 10 for performance)
      const limit = Math.min(matchingOrgs.length, 10);
      for (let i = 0; i < limit; i++) {
        const org = matchingOrgs[i];
        const orgItem = document.createElement("div");
        orgItem.className = "org-item";
        
        // Get color for organization type
        const typeColor = getTypeColor(org.OrgType);
        const rgbColor = `rgb(${typeColor[0]}, ${typeColor[1]}, ${typeColor[2]})`;
        
        // Highlight search term
        let orgName = org.Name;
        if (orgName.toLowerCase().includes(searchTerm)) {
          const index = orgName.toLowerCase().indexOf(searchTerm);
          orgName = 
            orgName.substring(0, index) + 
            `<span class="highlight">${orgName.substring(index, index + searchTerm.length)}</span>` + 
            orgName.substring(index + searchTerm.length);
        }
        
        // Include type indicator
        const typeIndicator = `<span class="type-indicator" style="background-color: ${rgbColor};"></span>`;
        
        orgItem.innerHTML = `
          <div class="org-name">${typeIndicator}${orgName}</div>
          <div>${org["Total revenues"]}</div>
          <div>${org.City}, ${org.State}</div>
        `;
        
        // Make clickable to zoom to city
        orgItem.style.cursor = "pointer";
        orgItem.onclick = function() {
          // Zoom to organization's city
          const city = org.City;
          if (city && geocodeCache[city]) {
            const point = new Point({
              longitude: geocodeCache[city][0],
              latitude: geocodeCache[city][1]
            });
            
            view.goTo({
              target: point,
              zoom: 10
            }, { duration: 1000 });
            
            // Update info panel for this city
            selectedCity = city;
            updateInfoPanel(city);
          }
        };
        
        resultsDiv.appendChild(orgItem);
      }
      
      // Add "Show more" link if there are more than 10 results
      if (matchingOrgs.length > 10) {
        const showMoreLink = document.createElement("div");
        showMoreLink.style.textAlign = "center";
        showMoreLink.style.marginTop = "10px";
        showMoreLink.innerHTML = `<a href="#" style="color: #0079c1;">Show all ${matchingOrgs.length} results</a>`;
        
        showMoreLink.onclick = function(e) {
          e.preventDefault();
          
          // Remove limit and show all results
          resultsDiv.removeChild(showMoreLink);
          
          for (let i = 10; i < matchingOrgs.length; i++) {
            const org = matchingOrgs[i];
            const orgItem = document.createElement("div");
            orgItem.className = "org-item";
            
            // Get color for organization type
            const typeColor = getTypeColor(org.OrgType);
            const rgbColor = `rgb(${typeColor[0]}, ${typeColor[1]}, ${typeColor[2]})`;
            
            // Highlight search term
            let orgName = org.Name;
            if (orgName.toLowerCase().includes(searchTerm)) {
              const index = orgName.toLowerCase().indexOf(searchTerm);
              orgName = 
                orgName.substring(0, index) + 
                `<span class="highlight">${orgName.substring(index, index + searchTerm.length)}</span>` + 
                orgName.substring(index + searchTerm.length);
            }
            
            // Include type indicator
            const typeIndicator = `<span class="type-indicator" style="background-color: ${rgbColor};"></span>`;
            
            orgItem.innerHTML = `
              <div class="org-name">${typeIndicator}${orgName}</div>
              <div>${org["Total revenues"]}</div>
              <div>${org.City}, ${org.State}</div>
            `;
            
            // Make clickable to zoom to city
            orgItem.style.cursor = "pointer";
            orgItem.onclick = function() {
              // Zoom to organization's city
              const city = org.City;
              if (city && geocodeCache[city]) {
                const point = new Point({
                  longitude: geocodeCache[city][0],
                  latitude: geocodeCache[city][1]
                });
                
                view.goTo({
                  target: point,
                  zoom: 10
                }, { duration: 1000 });
                
                // Update info panel for this city
                selectedCity = city;
                updateInfoPanel(city);
              }
            };
            
            resultsDiv.appendChild(orgItem);
          }
        };
        
        resultsDiv.appendChild(showMoreLink);
      }
    }
    
    // Insert results after search container
    const searchContainer = document.querySelector(".search-container");
    searchContainer.parentNode.insertBefore(resultsDiv, searchContainer.nextSibling);
  }
  
  // Add event listener for search button
  searchBtn.addEventListener("click", performSearch);
  
  // Add event listener for Enter key
  searchInput.addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      performSearch();
    }
  });
}
          
          document.getElementById("filterLarge").addEventListener("click", function() {
            currentFilter = 'large';
            setActiveFilterButton(this, document.querySelectorAll(".filter-group:nth-child(2) .filter-btn"));
            filterGraphics();
            updateInfoPanel(selectedCity);
          });
          
          document.getElementById("filterMed").addEventListener("click", function() {
            currentFilter = 'med';
            setActiveFilterButton(this, document.querySelectorAll(".filter-group:nth-child(2) .filter-btn"));
            filterGraphics();
            updateInfoPanel(selectedCity);
          });
          
          document.getElementById("filterSmall").addEventListener("click", function() {
            currentFilter = 'small';
            setActiveFilterButton(this, document.querySelectorAll(".filter-group:nth-child(2) .filter-btn"));
            filterGraphics();
            updateInfoPanel(selectedCity);
          });
          
          // Handle filter buttons - Organization Type
          document.getElementById("filterAllTypes").addEventListener("click", function() {
            currentTypeFilter = 'all';
            setActiveFilterButton(this, document.querySelectorAll(".filter-group:nth-child(1) .filter-btn"));
            filterGraphics();
            updateInfoPanel(selectedCity);
          });
          
          document.getElementById("filterLand").addEventListener("click", function() {
            currentTypeFilter = 'Land';
            setActiveFilterButton(this, document.querySelectorAll(".filter-group:nth-child(1) .filter-btn"));
            filterGraphics();
            updateInfoPanel(selectedCity);
          });
          
          document.getElementById("filterWater").addEventListener("click", function() {
            currentTypeFilter = 'Water';
            setActiveFilterButton(this, document.querySelectorAll(".filter-group:nth-child(1) .filter-btn"));
            filterGraphics();
            updateInfoPanel(selectedCity);
          });
          
          document.getElementById("filterAgri").addEventListener("click", function() {
            currentTypeFilter = 'Agriculture';
            setActiveFilterButton(this, document.querySelectorAll(".filter-group:nth-child(1) .filter-btn"));
            filterGraphics();
            updateInfoPanel(selectedCity);
          });
          
          document.getElementById("filterBusiness").addEventListener("click", function() {
            currentTypeFilter = 'Business';
            setActiveFilterButton(this, document.querySelectorAll(".filter-group:nth-child(1) .filter-btn"));
            filterGraphics();
            updateInfoPanel(selectedCity);
          });
          
          document.getElementById("filterEnv").addEventListener("click", function() {
            currentTypeFilter = 'Environment';
            setActiveFilterButton(this, document.querySelectorAll(".filter-group:nth-child(1) .filter-btn"));
            filterGraphics();
            updateInfoPanel(selectedCity);
          });
          
          document.getElementById("filterLabor").addEventListener("click", function() {
            currentTypeFilter = 'Labor';
            setActiveFilterButton(this, document.querySelectorAll(".filter-group:nth-child(1) .filter-btn"));
            filterGraphics();
            updateInfoPanel(selectedCity);
          });
          
          document.getElementById("filterFarm").addEventListener("click", function() {
            currentTypeFilter = 'Farm';
            setActiveFilterButton(this, document.querySelectorAll(".filter-group:nth-child(1) .filter-btn"));
            filterGraphics();
            updateInfoPanel(selectedCity);
          });
          
          // Reset view button
          document.getElementById("resetViewBtn").addEventListener("click", function() {
            view.goTo(caExtent);
            selectedCity = null;
            updateInfoPanel();
          });
          
          // Reset cache button
          document.getElementById("resetCacheBtn").addEventListener("click", function() {
            if (confirm("This will reset your geocode cache. Continue?")) {
              if (resetGeocodeCache()) {
                alert("Geocache reset. Reloading the map...");
                location.reload();
              }
            }
          });

          // Add this new code at the end of the function
        document.getElementById("minimizeDebugBtn").addEventListener("click", function() {
          const debugPanel = document.getElementById("debugPanel");
            const btn = document.getElementById("minimizeDebugBtn");
    
            if (debugPanel.classList.contains("minimized")) {
            // Expand
            debugPanel.classList.remove("minimized");
            btn.textContent = "−"; // Minus sign
            } else {
            // Minimize
            debugPanel.classList.add("minimized");
            btn.textContent = "+"; // Plus sign
          }
          });

           setupSearchFunctionality();
        }
        // Initialize the application when view is ready
        view.when(function() {
          debugLog("Map view initialized");
          
          // Check for invalid coordinates before processing
          cleanupInvalidCachedCoordinates();
          
          // Add a test marker to verify the graphics layer is working
          addTestMarker();
          
          // Set up event handlers
          setupEventHandlers();
          
          // Load the CSV data and display organizations
          loadAllCSVData()
            .then(() => createCityMarkers())
            .then(() => {
              // Update info panel after all data is loaded and markers are created
              updateInfoPanel();
              debugLog("Map initialization complete");
            // Add the call to setupMobileResponsiveness() here
            setupMobileResponsiveness();
          })
            .catch(error => {
            debugLog(`Error initializing map data: ${error.message}`);
            document.getElementById("loadingOverlay").style.display = "none";
        });
        });
      } catch (error) {
        debugLog(`Error initializing map: ${error.message}`);
        console.error(error);
        
        // Hide loading overlay on critical error
        document.getElementById("loadingOverlay").style.display = "none";
      }
    });
  </script>
</body>
</html>
